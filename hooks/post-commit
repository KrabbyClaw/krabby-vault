#!/bin/bash
# post-commit hook - Auto-bump version after every commit
# Place in .git/hooks/post-commit

set -e

# Prevent infinite loops (when this hook creates a commit)
if [ -f .git/.version-bumping ]; then
    exit 0
fi

# Get current version
CURRENT_VERSION=$(cat package.json | grep '"version"' | head -1 | sed 's/.*: "\(.*\)".*/\1/')
MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

# Get last commit message
LAST_COMMIT=$(git log -1 --pretty=%B)
COMMIT_TYPE=$(echo "$LAST_COMMIT" | grep -oE '^(feat|fix|docs|chore|refactor|breaking|major)' | head -1)

# Determine bump type
if echo "$LAST_COMMIT" | grep -qE "^(breaking|major|BREAKING CHANGE)"; then
    BUMP_TYPE="major"
elif [ "$COMMIT_TYPE" = "feat" ]; then
    BUMP_TYPE="minor"
else
    BUMP_TYPE="patch"
fi

# Calculate new version
case $BUMP_TYPE in
    major)
        NEW_VERSION="$((MAJOR + 1)).0.0"
        ;;
    minor)
        NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
        ;;
    patch)
        NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
        ;;
esac

echo "üì¶ Auto-bumping version: $CURRENT_VERSION ‚Üí $NEW_VERSION ($BUMP_TYPE)"

# Update package.json
node -e "
const fs = require('fs');
try {
    const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    pkg.version = '$NEW_VERSION';
    fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\\n');
    console.log('‚úÖ Updated package.json to $NEW_VERSION');
} catch (e) {
    console.error('Failed to update package.json:', e.message);
    process.exit(1);
}
"

# Update VERSION file
echo "$NEW_VERSION" > VERSION

# Create lock file to prevent infinite loop
touch .git/.version-bumping

# Stage version files
git add package.json VERSION

# Amend commit with version bump
git commit --amend --no-edit

# Create tag
NEW_COMMIT=$(git rev-parse --short HEAD)
git tag -a "v$NEW_VERSION" -m "Version $NEW_VERSION" || echo "Tag v$NEW_VERSION already exists"

# Remove lock file
rm -f .git/.version-bumping

echo "‚úÖ Version auto-bumped to $NEW_VERSION (commit: $NEW_COMMIT)"
echo "üè∑Ô∏è  Tag v$NEW_VERSION created"
echo ""
echo "‚ö†Ô∏è  Remember to push with: git push origin master --follow-tags"
